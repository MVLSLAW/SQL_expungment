SELECT CaseNumber, (CASE WHEN pending > 0 THEN "Pending"
                    	 WHEN unexp=0 AND probablies=0 THEN "Yes"
                         WHEN unexp=0 AND probablies>0 THEN "Maybe"
 						 ELSE "No" END) as Expungability
FROM (
SELECT CaseNumber, 
       sum(CASE WHEN status = "No" THEN 1 ELSE 0 END) as unexp, 
       sum(case when status = "Probably" THEN 1 ELSE 0 END) as probablies,
       sum(CASE WHEN status = "Pending" THEN 1 ELSE 0 END) as pending
FROM (
SELECT cdi.CaseNumber, 
       cdi.ChargeNo,
       (CASE WHEN cdi.Disposition != '' THEN
        
       (CASE 

WHEN cdi.Disposition in ("NOT GUILTY", "DISMISSED","COMPROMISED", "JUDGMENT OF ACQUITAL","ACQUITTAL JUDGMENT GRANTED","MERGED","CLOSED - JEOPARDY OR OTHER CONVICTION")
     THEN "Yes"
WHEN (cdi.DispositionDate < date_sub(NOW(), INTERVAL 3 YEAR) AND cdi.Disposition IN ("NOLLE PROSEQUI", "STET", "NOT CRIMINALLY RESPONSIBLE", "NOT GUILTY FOR REASON OF INSANITY"))
     THEN "Probably"
WHEN (cdi.PBJEndDate < date_sub(NOW(), INTERVAL 3 YEAR) AND cdi.Disposition IN ("PBJ Supervised","PBJ Unsupervised","Probation Before Judgment") AND cdi.CJISCode NOT IN ("1 0765","1 0770","1 0775","1 0780","1 0900","1 0693","1 0755","1 0760"))
     THEN "Yes"
WHEN (cdi.Disposition='GUILTY' AND cdi.Description LIKE "%MARI%LESS THAN 10 G%") 
     THEN "Yes"
WHEN (cdi.DispositionDate < date_sub(NOW(), INTERVAL 4 YEAR) AND cdi.Disposition='GUILTY' AND cdi.Description LIKE "%CDS%MARI%" AND cdi.Description NOT LIKE '%NOT%')
     THEN "Yes"
WHEN (cdi.Disposition='GUILTY' AND cdi.Description LIKE "%CDS%MARI%" AND cdi.Description NOT LIKE '%NOT%')
     THEN "Probably"
WHEN (cdi.Disposition='GUILTY' AND (cdi.Description LIKE "%URINAT%" or cdi.Description LIKE "%PANHAN%" or cdi.Description LIKE "%SLEEP%" or cdi.Description LIKE '%OPEN CONT%' OR Description LIKE '%CONS%ALC%PUB%'Or cdi.Description LIKE '%FAIL%FARE%') AND cdi.DispositionDate < date_sub(NOW(), INTERVAL 3 YEAR))
     THEN "Probably"
ELSE "No"
                    END)
     ELSE (CASE WHEN ci.CaseDisposition LIKE '%Juvenile%' THEN "Yes" ELSE "Pending" END) END)
        as status
FROM `charge_and_disposition_information` as cdi
INNER JOIN case_information as ci ON ci.CaseNumber=cdi.CaseNumber
LIMIT 5000
    ) as inside
GROUP BY CaseNumber ) as med
